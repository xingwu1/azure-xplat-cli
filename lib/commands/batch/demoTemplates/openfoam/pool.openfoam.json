{
    "parameters": {
        "vmSize": {
            "type": "string",
            "metadata": {
                "description": "The size of the virtual machines that runs the application"
            },
            "defaultValue": "STANDARD_D8",
            "allowedValues": [
                "STANDARD_A8",
                "STANDARD_A9"
            ]
        },
        "vmCount": {
            "type": "int",
            "defaultValue": 16,
            "metadata": {
                "description": "The number of the virtual machines"
            }
        },
        "poolName": {
            "type": "string",
            "defaultValue": "openfoam",
            "metadata": {
                "description": "The name of Azure Batch pool"
            }
        },
        "dataGroup": {
            "type": "string",
            "defaultValue": "openfoam",
            "metadata": {
                "description": "The auto-storage group where the input data is stored"
            }
        }
    },
    "pool": {
        "type": "Microsoft.Batch/batchAccounts/pools",
        "apiVersion": "2016-12-01",
        "properties": {
            "id": "[parameters('poolName')]",
            "virtualMachineConfiguration": {
                "imageReference": {
                    "publisher": "OpenLogic",
                    "offer": "CentOS-HPC",
                    "sku": "7.1",
                    "version": "latest"
                },
                "nodeAgentSKUId": "batch.node.centos 7"
            },
            "vmSize": "[parameters('vmSize')]",
            "targetDedicated": "[parameters('vmCount')]",
            "enableAutoScale": false,
            "enableInterNodeCommunication": true,
            "maxTasksPerNode": 1,
            "startTask": {
                "commandLine": "/bin/bash -c 'set -e; set -o pipefail; nodeprep-cmd' ; wait",
                "runElevated": true,
                "waitForSuccess": true,
                "resourceFiles": [
                    {
                        "source": { 
                            "fileGroup": "[parameters('dataGroup')]",
                            "prefix": "nodeprep-cmd"
                        }
                    }
                ]
            }
        }
    }
}